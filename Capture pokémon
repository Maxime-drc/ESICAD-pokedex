<?php
$page_title = 'Capturer un Pokémon';
require_once('config.php');
require_once('header.php');

// Vérifier si l'utilisateur est connecté
requireLogin();

$success = '';
$error = '';

// Si un formulaire de capture a été soumis
if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['pokemon_id'])) {
    $pokemon_id = (int)$_POST['pokemon_id'];
    $user_id = $_SESSION['user_id'];
    $date_capture = date('Y-m-d'); // Date du jour
    
    // Si la date de capture a été spécifiée
    if (!empty($_POST['date_capture'])) {
        $date_capture = $_POST['date_capture'];
    }
    
    // Vérifier que le Pokémon existe
    $pokemon = getPokemonById($pokemon_id);
    
    if ($pokemon) {
        // Insérer la capture dans la base de données
        $sql = "INSERT INTO capture_pokemon (user_id, pokemon_id, date_capture) VALUES (?, ?, ?)";
        $stmt = $conn->prepare($sql);
        $stmt->bind_param("iis", $user_id, $pokemon_id, $date_capture);
        
        if ($stmt->execute()) {
            $success = "Félicitations ! Vous avez capturé " . $pokemon['nom'] . " !";
        } else {
            $error = "Erreur lors de la capture: " . $conn->error;
        }
    } else {
        $error = "Ce Pokémon n'existe pas.";
    }
}

// Récupérer la liste des Pokémon depuis la base de données
$sql = "SELECT id, nom, numero FROM pokemon ORDER BY numero";
$result = $conn->query($sql);
$pokemons = [];

if ($result && $result->num_rows > 0) {
    while ($row = $result->fetch_assoc()) {
        $pokemons[] = $row;
    }
}
?>

<h1>Capturer un Pokémon</h1>

<?php if ($success): ?>
    <div class="success"><?php echo $success; ?></div>
<?php endif; ?>

<?php if ($error): ?>
    <div class="error"><?php echo $error; ?></div>
<?php endif; ?>

<div class="capture-form">
    <form method="post" action="">
        <div class="form-group">
            <label for="pokemon_id">Sélectionnez un Pokémon:</label>
            <select id="pokemon_id" name="pokemon_id" required>
                <option value="">Choisir un Pokémon</option>
                <?php foreach ($pokemons as $pokemon): ?>
                    <option value="<?php echo $pokemon['id']; ?>">
                        #<?php echo $pokemon['numero']; ?> - <?php echo htmlspecialchars($pokemon['nom']); ?>
                    </option>
                <?php endforeach; ?>
            </select>
        </div>
        
        <div class="form-group">
            <label for="date_capture">Date de capture:</label>
            <input type="date" id="date_capture" name="date_capture" value="<?php echo date('Y-m-d'); ?>">
        </div>
        
        <button type="submit" class="btn">Capturer ce Pokémon</button>
    </form>
</div>

<?php require_once('footer.php'); ?>